package com.whv.common.utils.io;

import java.io.File;
import java.io.FileFilter;
import java.io.FilenameFilter;
import java.util.List;

import com.whv.common.utils.MathUtil;

/**
 * 文件操作工具类
 * @author huawei
 *
 */
public class FileUtil {
	/**
	 * 获取目录下的所有文件列表
	 * @param strPath 目录路径
	 * @param filelist 当前文件列表
	 * @return 文件列表
	 */
		public static List<File> getFileList(String strPath,List<File> filelist) {
	        File dir = new File(strPath);
	        File[] files = dir.listFiles(); // 该文件目录下文件全部放入数组
	        if (files != null) {
	            for (int i = 0; i < files.length; i++) {
	                if (files[i].isDirectory()) { // 判断是文件还是文件夹
	                    getFileList(files[i].getAbsolutePath(),filelist); // 获取文件绝对路径
	                } else { 
	                    filelist.add(files[i]);
	                }
	            }

	        }
	        return filelist;
	    }
/**
 * 获取目录下的所有文件列表
 * @param strPath 目录路径
 * @param filelist 当前文件列表
 * @param type 文件后缀
 * @param nameRegex 名称正则表达式
 * @return 文件列表
 */
	public static List<File> getFileList(String strPath,List<File> filelist,String type,String nameRegex) {
        File dir = new File(strPath);
        FilesFilter fileFilter = new  FilesFilter(type, nameRegex);
        File[] files = dir.listFiles(fileFilter); // 该文件目录下文件全部放入数组
        if (files != null) {
            for (int i = 0; i < files.length; i++) {
                if (files[i].isDirectory()) { // 判断是文件还是文件夹
                    getFileList(files[i].getAbsolutePath(),filelist,type, nameRegex); // 获取文件绝对路径
                } else { 
                    filelist.add(files[i]);
                }
            }

        }
        return filelist;
    }
	/**
	 * 获取重命名后的文件
	 * @param fileName 文件名
	 * @param path 文件保存目录
	 * @return File
	 */
	public static File getRenameFile(String fileName,String path) {
		if(path==null) path="";
		if(path.endsWith(fileName)) {
			path = path.substring(0, path.lastIndexOf(fileName));
		}
		File dir = new File(path);
		if(!dir.exists()) {
			dir.mkdirs();
		}else {
			if(!dir.isDirectory()) {
				dir = new File(path+"_DIR");
				if(!dir.exists()) {
					dir.mkdirs();
				}
			}
		}
		String type = fileName.substring(fileName.lastIndexOf("."));
		String fileNamePre = fileName.substring(0, fileName.lastIndexOf("."));
		String nameRegex = "\\Q"+fileNamePre+"\\E(\\(\\d+\\))?\\Q"+type+"\\E";
		NamesFilter namesFilter = new  NamesFilter(type, nameRegex);
		File[] files = dir.listFiles(namesFilter);
		String fileNameStr = fileName;
		int i=0;
		for(File file :files) {
			String subName = file.getName();
			if(subName.equals(fileName)) {
				if(i==0) {
					i=1;
				}
			}else {
				int fileNum = Integer.valueOf(subName.substring(subName.lastIndexOf("(")+1, subName.lastIndexOf(")")));
				if(i<=fileNum) {
					i=fileNum+1;
				}
			}
		}
		if(i>0) {
			fileNameStr = fileNamePre+"("+i+")"+type;
		}
		return new File(dir.getPath()+File.separator+fileNameStr);
	}
	/**
	 * 获取格式化后的文件大小
	 * @param file 文件
	 * @param format 格式：MB、KB、B、GB
	 * @param scale 精确位数
	 * @return 格式化后的字符串
	 */
	public static String getFileSize(File file,String format,int scale) {
		format = format==null||format.isEmpty()?"MB":format;
		String fileSize = "0";
		if(file != null && file.exists()) {
			long fileLength = file.length();
			double unitVal = 1024;
			if("MB".equals(format)) {
				fileSize = MathUtil.div(fileLength+"", Math.pow(unitVal, 2)+"", scale);
			}else if("KB".equals(format)) {
				fileSize = MathUtil.div(fileLength+"", unitVal+"", scale);
			}else if("GB".equals(format)) {
				fileSize = MathUtil.div(fileLength+"", Math.pow(unitVal, 3)+"", scale);
			}else if("B".equals(format)){
				fileSize = fileLength+"";
			}else {
				fileSize = MathUtil.div(fileLength+"", Math.pow(unitVal, 2)+"", scale);
			}
		}
		return fileSize;
	}
	/**
	 * 获取格式化后的文件大小，精确到小数点后两位
	 * @param file 文件
	 * @param format 格式：MB、KB、B、GB
	 * @return 格式化后的字符串
	 */
	public static String getFileSize(File file,String format) {
		return getFileSize(file, format, 2);
	}
	/**
	 * 文件名称列表过滤器
	 * @author huawei
	 *
	 */
	protected static class NamesFilter implements FilenameFilter{  
        private String type;  
        private String nameRegex;
        public NamesFilter(){  
            this.type = "";  
            this.nameRegex = ".*";
        }  
        /**
         * 文件名称列表过滤构造方法
         * @param type 文件扩展名
         * @param nameRegex 文件名称匹配正则
         */
        public NamesFilter(String type,String nameRegex){  
            this.type = type==null?"":type;  
            this.nameRegex = nameRegex==null?".*":nameRegex;
        }  
        public boolean accept(File dir,String name){  
            return name.endsWith(type)&&name.matches(nameRegex);  
        }  
    }  
	/**
	 * 文件列表过滤器
	 * @author huawei
	 *
	 */
	protected static class FilesFilter implements FileFilter{  
        private String type;  
        private String nameRegex;
        public FilesFilter(){  
            this.type = "";  
            this.nameRegex = ".*";
        }  
        /**
         * 文件列表过滤构造方法
         * @param type 文件扩展名
         * @param nameRegex 文件名称匹配正则
         */
        public FilesFilter(String type,String nameRegex){  
            this.type = type==null?"":type;  
            this.nameRegex = nameRegex==null?".*":nameRegex;
        }  
		public boolean accept(File pathname) {
			return pathname.isDirectory()||
					(pathname.getName().endsWith(type)&&pathname.getName().matches(nameRegex));
		}  
    }  
}
